#!/bin/bash

# MinIO bucket creation script
# Usage: ./create_bucket <bucket_name>

{{- $minio := (datasource "config").minio }}
{{- $user := $minio.auth.user }}
{{- $password := $minio.auth.password | default (crypto.PBKDF2 $user "opencsg" 2048 8) }}

# Configuration
MC_PATH="/opt/csghub/embedded/bin/mc"          # Path to mc client
MINIO_ALIAS="myMinio"                          # MinIO alias name
MINIO_ENDPOINT="http://127.0.0.1:9000"         # MinIO server endpoint
MINIO_ACCESS_KEY={{ $user }}                   # Access key
MINIO_SECRET_KEY={{ $password }}               # Secret key

# Validate argument count
if [ "$#" -lt 1 ] || [ "$#" -gt 2 ]; then
    echo "Error: Script requires 1 or 2 arguments - bucket name [anonymous]"
    echo "Usage: $0 <bucket_name> [public|private]"
    exit 1
fi

BUCKET_NAME=$1
ANONYMOUS="${2:-private}"

# Validate bucket name format
if [[ ! "$BUCKET_NAME" =~ ^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$ ]]; then
    echo "Error: Invalid bucket name"
    echo "Bucket names must:"
    echo "1. Be 3-63 characters long"
    echo "2. Contain only lowercase letters, numbers, and hyphens"
    echo "3. Start and end with a letter or number"
    exit 1
fi

# Validate Anonymous policy format
if [[ "$ANONYMOUS" != "public" && "$ANONYMOUS" != "private" ]]; then
    echo "Error: Invalid anonymous access policy"
    echo "Anonymous access policy must be set to 'public' or 'private'"
    exit 1
fi

# Check if mc client is installed
if ! command -v "$MC_PATH" &> /dev/null; then
    echo "Error: MinIO client (mc) not found or not in PATH"
    echo "Please download and install mc from https://min.io/download"
    exit 1
fi

# Configure MinIO alias if not already set
if ! "$MC_PATH" alias list | grep -q "$MINIO_ALIAS"; then
    "$MC_PATH" alias set "$MINIO_ALIAS" "$MINIO_ENDPOINT" "$MINIO_ACCESS_KEY" "$MINIO_SECRET_KEY"
    if [ $? -ne 0 ]; then
        exit 1
    fi
fi

# Check if bucket already exists
if "$MC_PATH" ls "$MINIO_ALIAS/$BUCKET_NAME" &> /dev/null; then
    echo "Warn: Bucket '$BUCKET_NAME' already exists"
    exit 0
fi

# Create the bucket
echo "Creating bucket: $BUCKET_NAME"
if "$MC_PATH" mb "$MINIO_ALIAS/$BUCKET_NAME"; then
    echo "Successfully created bucket: $BUCKET_NAME"
else
    echo "Failed to create bucket"
    exit 1
fi

# Set Anonymous access policy
echo "Setting bucket policy to: $ANONYMOUS"
if [[ "$ANONYMOUS" == "public" ]]; then
    "$MC_PATH" anonymous set download "$MINIO_ALIAS/$BUCKET_NAME"
    echo "Bucket is now publicly readable"
else
    "$MC_PATH" anonymous set none "$MINIO_ALIAS/$BUCKET_NAME"
    echo "Bucket is now private"
fi
