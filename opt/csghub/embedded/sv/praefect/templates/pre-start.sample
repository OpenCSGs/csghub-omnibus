#!/bin/bash

# Redirect stderr -> stdout
exec 2>&1

{{- $envDir := "/opt/csghub/etc/praefect/env" }}
cd {{ $envDir }}
{{- $dataDir := (datasource "config").praefect.data_dir | default "/var/opt/csghub/praefect" }}
chown -R git:git {{ $dataDir }} || true

{{- $pidFile := printf "%s/praefect.pid" $dataDir }}
if [ ! -s {{ $pidFile }} ]; then
  echo 0 > {{ $pidFile }}
fi
{{- file.Write (printf "%s/GITALY_PID_FILE" $envDir) $pidFile }}

exit 0