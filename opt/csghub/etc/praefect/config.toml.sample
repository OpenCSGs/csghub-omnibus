# Gitaly Praefect configuration file
# This file is managed by csghub-ctl. Manual changes will be
# erased! To change the contents below, edit /etc/csghub/csghub.yaml
# and run:
# sudo csghub-ctl reconfigure

{{- $praefect := (datasource "config").praefect }}
# TCP address to listen on
listen_addr = "{{ $praefect.listen_addr | default "127.0.0.1:2305" }}"

{{- if $praefect.tls_listen_addr }}
# Secured TCP address to listen on.
tls_listen_addr = "{{ $praefect.tls_listen_addr }}"
{{- end }}

{{- if has $praefect "tls" }}
# Path to the certificate and its key used for TLS listening address.
[tls]
{{- if $praefect.tls.certificate_path }}
certificate_path = "{{ $praefect.tls.certificate_path }}"
{{- end }}
{{- if $praefect.tls.key_path }}
key_path = "{{ $praefect.tls.key_path }}"
{{- end }}
{{- end }}

# Optional: grace period before a praefect process is forcibly terminated (duration)
# Defaults to "1m"
graceful_stop_timeout = "{{ $praefect.graceful_stop_timeout | default "30s" }}"

# Optional: export metrics via Prometheus
prometheus_listen_addr = "{{ $praefect.prometheus_listen_addr | default "127.0.0.1:9652" }}"

{{- if has $praefect "logging" }}
# You can optionally configure Praefect to output JSON-formatted log messages to stdout
[logging]
format = "{{ $praefect.logging.format | default "json" }}"
# Optional: Set log level to only log entries with that severity or above
# One of, in order: debug, info, warn, error, fatal, panic
# Defaults to "info"
level = "{{ $praefect.logging.level | default "warn" }}"
{{ end }}

{{ if has $praefect "prometheus" }}
[prometheus]
{{- if $praefect.prometheus.grpc_latency_buckets }}
grpc_latency_buckets = [ {{ $praefect.prometheus.grpc_latency_buckets | default }} ]
{{- else }}
grpc_latency_buckets = [ 0.001, 0.005, 0.025, 0.1, 0.5, 1.0, 10.0, 30.0, 60.0, 300.0, 1500.0 ]
{{- end }}
{{ end }}

{{- if has $praefect "sentry" }}
[sentry]
{{- if $praefect.sentry.sentry_environment }}
sentry_environment = "{{ $praefect.sentry.sentry_environment | default "" }}"
{{- end }}
{{- if $praefect.sentry.sentry_dsn }}
sentry_dsn = "{{ $praefect.sentry.sentry_dsn | default "" }}"
{{- end }}
{{ end }}

{{- if has $praefect "database" }}
[database]
host = "{{ $praefect.database.host | default "127.0.0.1" }}"
port = {{ $praefect.database.port | default 5432 }}
user = "{{ $praefect.database.user | default "praefect" }}"
password = "{{ $praefect.database.password | default "" }}"
dbname = "{{ $praefect.database.dbname | default "praefect_production" }}"
{{ end }}

{{- if has $praefect "auth" }}
# Optional: authenticate Gitaly requests using a shared secret. This token works the same way as a gitaly token
[auth]
token = "{{ $praefect.auth.token | default "abc123secret" }}"
{{ end }}

{{- if has $praefect "replication" }}
# One or more Gitaly servers need to be configured to be managed. The names
# of each server are used to link multiple nodes, or `gitaly_server`s together
# as shard. listen_addr should be unique for all nodes.
# Requires the protocol to be defined, e.g. tcp://host.tld:1234
[replication]
batch_size = {{ $praefect.replication.batch_size | default 10 }}
{{ end }}

{{- if has $praefect "reconciliation" }}
[reconciliation]
# Duration value specifying an interval at which to run the automatic repository reconciler.
# Automatic reconciliation is disabled if set to 0. Example: "1m" for reconciliation every minute.
scheduling_interval = "{{ $praefect.reconciliation.scheduling_interval | default "1m" }}"
# Scheduling duration histogram buckets.
{{- if $praefect.reconciliation.histogram_buckets }}
histogram_buckets = [{{- range $i, $v := $praefect.reconciliation.histogram_buckets }}{{if $i}}, {{end}}{{$v}}{{- end }}]
{{- else }}
histogram_buckets = [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
{{- end }}
{{ end }}

{{- if has $praefect "failover" }}
[failover]
enabled = {{ $praefect.failover.enabled | default true }}
{{ end }}

{{- if has $praefect "delete_invalid_records" }}
[background_verification]
delete_invalid_records = {{ $praefect.background_verification.delete_invalid_records | default false }}
verification_interval = "{{ $praefect.background_verification.verification_interval | default "72h" }}"
{{ end }}

{{- if has $praefect "virtual_storage" }}
{{- range $vs := $praefect.virtual_storage }}
[[virtual_storage]]
name = "{{ $vs.name }}"
{{- if $vs.default_replication_factor }}
default_replication_factor = {{ $vs.default_replication_factor }}
{{- end }}
{{- if $vs.nodes }}
{{- range $node := $vs.nodes }}
[[virtual_storage.node]]
storage = "{{ $node.storage }}"
address = "{{ $node.address }}"
token = "{{ $node.token }}"
{{ end }}
{{- end }}
{{- end }}
{{ end }}

{{- if has $praefect "yamux" }}
[yamux]
# MaximumStreamWindowSizeBytes sets the maximum window size in bytes used for yamux streams.
# Higher value can increase throughput at the cost of more memory usage.
maximum_stream_window_size_bytes = {{ $praefect.yamux.maximum_stream_window_size_bytes | default 262144 }}
# AcceptBacklog sets the maximum number of stream openings in-flight
# before further openings block.
accept_backlog = {{ $praefect.yamux.accept_backlog | default 256 }}
{{ end }}
