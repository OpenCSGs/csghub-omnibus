#!/bin/bash
# Purpose: Automatically execute PostgreSQL SQL scripts on specified database
# Usage: ./pg_executor <database_name> <user> <password> [host] [port]

set -euo pipefail  # Strict error handling

export PATH=/opt/csghub/embedded/bin/:/opt/csghub/embedded/sv/postgresql/bin/:$PATH

# Validate input parameters
if [ -z "$DSN" ]; then
  echo -e "\033[31mError: Env DSN empty!\033[0m"
  exit 1
fi

if [ $# -eq 0 ]; then
  echo -e "\033[33mWarn: scripts directory not specified! Using default ./scripts\033[0m"
  echo "Usage: $0 [directory_path]"
fi

SCRIPT_DIR=${1:-"./scripts"}

# Check if directory exists
if [ ! -d "$SCRIPT_DIR" ]; then
  echo -e "\033[31mError: Directory '$SCRIPT_DIR' not found!\033[0m"
  exit 0
fi

# Get list of SQL files
SQL_FILES=$(find "$SCRIPT_DIR" -type f -name "*.sql" | sort)

if [ -z "$SQL_FILES" ]; then
  echo -e "\033[34mNotice: No SQL files found in '$SCRIPT_DIR'\033[0m"
  exit 0
fi

# Execute each SQL file
for SQL_FILE in $SQL_FILES; do
  echo -e "\033[32mExecuting $SQL_FILE\033[0m"
  if ! psql "$DSN" -f "$SQL_FILE"; then
    echo -e "\033[31mError: Failed to execute $SQL_FILE\033[0m"
    exit 1
  fi
done

echo -e "\n\033[32mSuccessfully executed all SQL files!\033[0m"