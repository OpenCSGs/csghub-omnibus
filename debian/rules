#!/usr/bin/make -f

# See debhelper(7) (uncomment to enable).
# Output every command that modifies files on the build system.
# export DH_VERBOSE = 1
#
#
EMBEDDED_DIR="/opt/csghub/embedded"

RUNIT_ARCHIVE="runit-2.2.0.tar.gz"
RUNIT_DIR="debian/source/runit"
GOMPLATE_FILE="gomplate_linux-amd64"
PGSQL_ARCHIVE="postgresql-16.8.tar.gz"
PGSQL_DIR="debian/source/postgresql-16.8"

define extract_source
    mkdir -p $(1) && \
    tar --strip-components=1 -xzf $(2) -C $(1) && \
    chmod -R +w $(1)
endef

%:
	dh $@

override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=--warnings=0

override_dh_auto_configure:
	# Runit
	$(call extract_source, $(RUNIT_DIR), $(RUNIT_ARCHIVE))

	# PostgreSQL configure
	$(call extract_source, $(PGSQL_DIR), $(PGSQL_ARCHIVE))
	cd $(PGSQL_DIR) && ./configure --prefix=/opt/csghub/embedded/sv/postgresql \
		--with-openssl \
		--with-icu

override_dh_auto_build:
	# PostgreSQL make
	cd $(PGSQL_DIR) && \
		$(MAKE) -C src/backend generated-headers && \
		$(MAKE) world -j2

override_dh_auto_install:
	# Generate conffiles
	# echo "/etc/csghub/csghub.yaml" > debian/omnibus-csghub.conffiles
	# Runit
	install -d -m 755 $(CURDIR)/debian/tmp$(EMBEDDED_DIR)/bin
	cd $(RUNIT_DIR)/runit-* && package/install && \
		cp command/* $(CURDIR)/debian/tmp/$(EMBEDDED_DIR)/bin

	# Gomplate
	install -m 755 $(GOMPLATE_FILE) $(CURDIR)/debian/tmp/$(EMBEDDED_DIR)/bin/gomplate

	# PostgreSQL install
	cd $(PGSQL_DIR) && $(MAKE) install-world -j2 DESTDIR=$(CURDIR)/debian/tmp

	# Others auto-install
	dh_auto_install

override_dh_clean:
	# PostgreSQL clean
	if [ -f $(PGSQL_DIR)/GNUmakefile ]; then \
		$(MAKE) -C $(PGSQL_DIR) distclean; \
	fi

        # Other clean
	dh_clean